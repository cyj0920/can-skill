# CAN 工程实践指南

## FULL vs BASIC 选择指南

### FULL-CAN 适用场景
- 诊断响应报文（实时性要求高）
- 关键功能性周期报文
- 多帧分段报文（如UDS传输）
- 需要优先级调度的报文

### BASIC-CAN 适用场景
- 低优先级应用周期报文
- 测试报文、调试报文
- 资源受限的系统

## 周期报文配置策略

### 发送模式选择
| 报文类型 | CanHandleType | ProcessingType | 说明 |
|----------|---------------|----------------|------|
| 应用周期报文 | FULL | POLLING | 资源可控 |
| 诊断响应 | FULL | INTERRUPT | 实时、独立 |
| 低优先级 | BASIC | POLLING | 节省资源 |

### 周期配置要点
- 避免所有报文在同一时刻发送
- 分散发送时间点，降低总线负载峰值
- 考虑总线负载率（建议<70%）

## 诊断响应报文配置

### 为什么不推荐 BASIC + INTERRUPT？

1. **实时性要求高**
   - UDS要求固定时间窗口响应（如50ms）
   - BASIC的FIFO可能导致超时

2. **多帧传输要求并发性**
   - 诊断响应可能涉及多帧
   - BASIC不支持并发多个Tx报文

3. **共享资源冲突**
   - 诊断报文与应用报文可能互相干扰

### 推荐配置
`xml
<CanHardwareObject>
  <CanHandleType>FULL</CanHandleType>
  <CanObjectType>TRANSMIT</CanObjectType>
  <ProcessingType>INTERRUPT</ProcessingType>
</CanHardwareObject>
`

## FIFO深度配置陷阱

### 问题案例
FIFO深度配置为32，中断在满时才触发：
- 预期：每200ms接收一条消息
- 实际：32条消息满时才中断，延迟6.4秒

### 解决方案
1. **减小FIFO深度**: 根据接收频率设置
2. **使用中断阈值**: 配置部分满就触发中断
3. **使用Full-CAN**: 每个报文独立HOH

## 中断 vs 轮询模式选择

### INTERRUPT模式
**优点:**
- 实时响应快
- 适合事件触发报文

**缺点:**
- 系统负担重
- 中断嵌套复杂

**适用:** 诊断响应、紧急事件

### POLLING模式
**优点:**
- 降低中断压力
- 调度统一

**缺点:**
- 响应有延迟
- 需要周期任务

**适用:** 周期报文、大量数据通信

## 常见配置错误

### 错误1: 波特率配置不匹配
`c
// 错误: 不同节点使用不同时钟源
Node1: 80MHz / 8 / (1+8+7+4) = 500k
Node2: 72MHz / 8 / (1+8+7+4) = 450k  // 不匹配!
`

### 错误2: 采样点配置不当
- 高速CAN FD: 采样点建议75-80%
- 经典CAN: 采样点建议87.5%
- 不一致导致错误帧

### 错误3: 过滤器配置过于宽泛
- 接收过多无用报文
- 增加CPU负载
- 可能导致FIFO溢出

## 最佳实践检查清单

### 配置阶段
- [ ] 确认所有节点波特率一致
- [ ] 验证采样点配置
- [ ] 检查ID过滤器配置
- [ ] 确认HOH数量足够
- [ ] 验证FIFO深度配置

### 调试阶段
- [ ] 监控TEC/REC计数器
- [ ] 检查BusOff恢复机制
- [ ] 验证报文时间间隔
- [ ] 测试错误注入
- [ ] 检查负载率

### 验证阶段
- [ ] 长时间稳定性测试
- [ ] 极端温度测试
- [ ] 错误恢复测试
- [ ] 总线负载测试
- [ ] 优先级反转测试
