# CAN 优先级反转问题

## 什么是优先级反转？

优先级反转是指高优先级的报文被低优先级的报文阻塞，导致高优先级报文无法及时发送的现象。

## 内部优先级反转

### 原因
当只使用单个发送缓冲区（Basic-CAN模式）时，低优先级报文占用缓冲区，高优先级报文必须等待。

### 解决方案
1. **使用Full-CAN模式**: 多个独立的发送缓冲区
2. **启用Multiplexed Transmission**: 多硬件对象到一个HTH
3. **配置多个HTH**: 为高优先级报文分配专用通道

## 外部优先级反转

### 原因
由于两个连续发送的L-PDU之间存在时间间隔，另一个节点可以抢先发送低优先级报文。

### 最小帧间间隔
CAN标准定义的最小间空间由ITM（Intermission）确定，为3个隐性位。

### 解决方案
1. **优化软件处理时间**: 减少发送间隔
2. **使用硬件自动重发**: 避免软件介入
3. **配置适当的HTH**: 确保连续发送能力

## AUTOSAR配置建议

| 类型 | 缓冲区 | 并发支持 | 优先级 | 适用场景 |
|------|--------|----------|--------|----------|
| Full-CAN | 独立 | 支持 | 支持 | 关键报文 |
| Basic-CAN | 共享FIFO | 不支持 | 不支持 | 低优先级报文 |

### 推荐配置
- **诊断响应报文**: Full-CAN + INTERRUPT
- **周期应用报文**: Full-CAN + POLLING
- **低优先级报文**: Basic-CAN + POLLING
